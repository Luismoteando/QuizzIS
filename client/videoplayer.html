<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Videoplayer</title>
    <link rel="stylesheet" href="css/videoplayer.css">
</head>

<body>
    <span id="spanTempo"></span>

    <img id="imgSelec14" src="media/img/selecarriba.svg"></img>
    <img id="imgSelec24" src="media/img/selecarriba.svg"></img>
    <img id="imgSelec34" src="media/img/selecabajo.svg"></img>
    <img id="imgSelec44" src="media/img/selecabajo.svg"></img>

    <img id="imgSelec13" src="media/img/selec.svg"></img>
    <img id="imgSelec23" src="media/img/selec.svg"></img>
    <img id="imgSelec33" src="media/img/selec.svg"></img>

    <img id="imgPrimero" style="display: none;" src="media/img/primero.svg"></img>
    <img id="imgSegundo" style="display: none;" src="media/img/segundo.svg"></img>
    <img id="imgTercero" style="display: none;" src="media/img/tercero.svg"></img>

    <strong><span id="spanAliasA"></span></strong>
    <span id="spanScoreA"></span>
    <strong><span id="spanAliasB"></span></strong>
    <span id="spanScoreB"></span>
    <strong><span id="spanAliasC"></span></strong>
    <span id="spanScoreC"></span>

    <div class="fullscreen-bg">
        <video id="videoPlayer1" autoplay muted></video>
        <video id="videoPlayer2" autoplay muted></video>
    </div>

    <script src="js/jquery.min.js"></script>
    <script>
        var phase = "bach";
        var semaphore = 1;
        var play = true;
        var mode = "questions";
        var category = "mandatory";
        var mandatoryBach = 1;
        var generalBach = 1;
        var mandatoryCycl = 1;
        var generalCycl = 1;
        var lead = 1;
        var option = 0;
        var solution = false;
        var time = 0;
        var teamBachA = null;
        var teamBachB = null;
        var teamBachC = null;
        var teamCyclA = null;
        var teamCyclB = null;
        var teamCyclC = null;

        $(document).ready(function() {
            runPoll();
        });

        function runPoll() {
            setTimeout(function() {
                $.ajax({
                    url: 'http://192.168.0.8:8888/server/server.php',
                    success: function(response) {
                        checkPlay(response);
                        setTimer(response);
                        if (option != response[10].value) {
                            showOption(response);
                        }
                        if (solution != response[11].value) {
                            showSolution(response);
                        }
                        if (response[1].value == "questions") {
                            if (mandatoryBach != response[4].value[0] || generalBach != response[5].value[0] || mandatoryCycl != response[6].value[0] || generalCycl != response[7].value[0]) {
                                changeQuestion(response);
                            }
                        } else if (response[1].value == "leads") {
                            if (lead != response[2].value) {
                                changeLead(response);
                            }
                        } else if (response[1].value == "ranking") {
                            if (mode != response[1].value) {
                                changeRanking(response);
                            }
                        }
                    },
                    dataType: "json",
                    complete: function() {
                        runPoll();
                    }
                })
            }, 100);
        };

        function checkPlay(response) {
            play = response[8].value;

            if (videoPlayer1.style.display != "none") {
                if (!videoPlayer1.ended) {
                    if (play == true) {
                        if (videoPlayer1.paused) {
                            videoPlayer1.play();
                        }
                    } else if (play == false) {
                        if (!videoPlayer1.paused) {
                            videoPlayer1.pause();
                        }
                    }
                }
            } else if (videoPlayer2.style.display != "none") {
                if (!videoPlayer2.ended) {
                    if (play == true) {
                        if (videoPlayer2.paused) {
                            videoPlayer2.play();
                        }
                    } else if (play == false) {
                        if (!videoPlayer2.paused) {
                            videoPlayer2.pause();
                        }
                    }
                }
            }
        }

        function setTimer(response) {
            time = response[9].value;

            if (time >= 0) {
                spanTempo.innerHTML = time;
                spanTempo.style.display = "block";
            } else {
                spanTempo.innerHTML = "";
                spanTempo.style.display = "none";
            }
        }

        function showSolution(response) {
            phase = response[0].value;
            solution = response[11].value;

            if (solution == true) {
                if (semaphore % 2 == 0) {
                    if (phase == "bach") {
                        if (category == "mandatory") {
                            videoPlayer1.src = "media/questions/bach/mandatory/" + mandatoryBach + "/" + option + ".mp4";
                        } else if (category == "general") {
                            videoPlayer1.src = "media/questions/bach/general/" + generalBach + "/" + option + ".mp4";
                        }
                    } else if (phase == "cycl") {
                        if (category == "mandatory") {
                            videoPlayer1.src = "media/questions/cycl/mandatory/" + mandatoryCycl + "/" + option + ".mp4";
                        } else if (category == "general") {
                            videoPlayer1.src = "media/questions/cycl/general/" + generalCycl + "/" + option + ".mp4";
                        }
                    }

                    videoPlayer1.oncanplaythrough = function() {
                        clearOptions();
                        clearRanking();
                        videoPlayer2.style.display = "none";
                        videoPlayer1.style.display = "block";
                        semaphore++;
                    }
                } else {
                    if (phase == "bach") {
                        if (category == "mandatory") {
                            videoPlayer2.src = "media/questions/bach/mandatory/" + mandatoryBach + "/" + option + ".mp4";
                        } else if (category == "general") {
                            videoPlayer2.src = "media/questions/bach/general/" + generalBach + "/" + option + ".mp4";
                        }
                    } else if (phase == "cycl") {
                        if (category == "mandatory") {
                            videoPlayer2.src = "media/questions/cycl/mandatory/" + mandatoryCycl + "/" + option + ".mp4";
                        } else if (category == "general") {
                            videoPlayer2.src = "media/questions/cycl/general/" + generalCycl + "/" + option + ".mp4";
                        }
                    }
                    videoPlayer2.oncanplaythrough = function() {
                        clearOptions();
                        clearRanking();
                        videoPlayer1.style.display = "none";
                        videoPlayer2.style.display = "block";
                        semaphore++;
                    }
                }
            }
        }

        function changeQuestion(response) {
            phase = response[0].value;
            mode = response[1].value;
            category = response[3].value;
            mandatoryBach = response[4].value[0];
            generalBach = response[5].value[0];
            mandatoryCycl = response[6].value[0];
            generalCycl = response[7].value[0];

            if (semaphore % 2 == 0) {
                if (phase == "bach") {
                    if (category == "mandatory") {
                        videoPlayer1.src = "media/questions/bach/mandatory/" + mandatoryBach + "/0.mp4";
                    } else if (category == "general") {
                        videoPlayer1.src = "media/questions/bach/general/" + generalBach + "/0.mp4";
                    }
                } else if (phase == "cycl") {
                    if (category == "mandatory") {
                        videoPlayer1.src = "media/questions/cycl/mandatory/" + mandatoryCycl + "/0.mp4";
                    } else if (category == "general") {
                        videoPlayer1.src = "media/questions/cycl/general/" + generalCycl + "/0.mp4";
                    }
                }
                videoPlayer1.oncanplaythrough = function() {
                    clearOptions();
                    clearRanking();
                    videoPlayer2.style.display = "none";
                    videoPlayer1.style.display = "block";
                    semaphore++;
                }
            } else {
                if (phase == "bach") {
                    if (category == "mandatory") {
                        videoPlayer2.src = "media/questions/bach/mandatory/" + mandatoryBach + "/0.mp4";
                    } else if (category == "general") {
                        videoPlayer2.src = "media/questions/bach/general/" + generalBach + "/0.mp4";
                    }
                } else if (phase == "cycl") {
                    if (category == "mandatory") {
                        videoPlayer2.src = "media/questions/cycl/mandatory/" + mandatoryCycl + "/0.mp4";
                    } else if (category == "general") {
                        videoPlayer2.src = "media/questions/cycl/general/" + generalCycl + "/0.mp4";
                    }
                }
                videoPlayer2.oncanplaythrough = function() {
                    clearOptions();
                    clearRanking();
                    videoPlayer1.style.display = "none";
                    videoPlayer2.style.display = "block";
                    semaphore++;
                }
            }
        }

        function changeLead(response) {
            mode = response[1].value;
            lead = response[2].value;

            if (semaphore % 2 == 0) {
                if (lead == 1) {
                    videoPlayer1.src = "media/leads/" + lead + ".mp4";
                } else {
                    videoPlayer1.src = "media/leads/" + lead + ".m4v";
                }
                videoPlayer1.oncanplaythrough = function() {
                    clearOptions();
                    clearRanking();
                    videoPlayer2.style.display = "none";
                    videoPlayer1.style.display = "block";
                    semaphore++;
                }
            } else {
                if (lead == 1) {
                    videoPlayer2.src = "media/leads/" + lead + ".mp4";
                } else {
                    videoPlayer2.src = "media/leads/" + lead + ".m4v";
                }
                videoPlayer2.oncanplaythrough = function() {
                    clearOptions();
                    clearRanking();
                    videoPlayer1.style.display = "none";
                    videoPlayer2.style.display = "block";
                    semaphore++;
                }
            }
        }

        function changeRanking(response) {
            mode = response[1].value;

            if (semaphore % 2 == 0) {
                videoPlayer1.src = "media/ranking/1.mp4";
                videoPlayer1.oncanplaythrough = function() {
                    clearOptions();
                    clearRanking();
                    setRanking(response);
                    videoPlayer2.style.display = "none";
                    videoPlayer1.style.display = "block";
                    semaphore++;
                }
            } else {
                videoPlayer2.src = "media/ranking/1.mp4";
                videoPlayer2.oncanplaythrough = function() {
                    clearOptions();
                    clearRanking();
                    setRanking(response);
                    videoPlayer1.style.display = "none";
                    videoPlayer2.style.display = "block";
                    semaphore++;
                }
            }
        }

        function setRanking(response) {
            phase = response[0].value;
            teamBachA = response[14];
            teamBachB = response[15];
            teamBachC = response[16];
            teamCyclA = response[17];
            teamCyclB = response[18];
            teamCyclC = response[19];

            var arr = [];
            if (phase == "bach") {
                arr.push(teamBachA, teamBachB, teamBachC);
                arr.sort(function(obj1, obj2) {
                    return obj1.value[1] - obj2.value[1];
                });

                $("#imgPrimero").addClass(arr[2]._id);
                $("#imgSegundo").addClass(arr[1]._id);
                $("#imgTercero").addClass(arr[0]._id);

                spanAliasA.innerHTML = teamBachA.value[0];
                spanAliasB.innerHTML = teamBachB.value[0];
                spanAliasC.innerHTML = teamBachC.value[0];

                spanScoreA.innerHTML = teamBachA.value[1];
                spanScoreB.innerHTML = teamBachB.value[1];
                spanScoreC.innerHTML = teamBachC.value[1];
            } else if (phase == "cycl") {
                arr.push(teamCyclA, teamCyclB, teamCyclC);
                arr.sort(function(obj1, obj2) {
                    return obj1.value[1] - obj2.value[1];
                });

                $("#imgPrimero").addClass(arr[2]._id);
                $("#imgSegundo").addClass(arr[1]._id);
                $("#imgTercero").addClass(arr[0]._id);

                spanAliasA.innerHTML = teamCyclA.value[0];
                spanAliasB.innerHTML = teamCyclB.value[0];
                spanAliasC.innerHTML = teamCyclC.value[0];

                spanScoreA.innerHTML = teamCyclA.value[1];
                spanScoreB.innerHTML = teamCyclB.value[1];
                spanScoreC.innerHTML = teamCyclC.value[1];
            }

            imgPrimero.style.display = "block";
            imgSegundo.style.display = "block";
            imgTercero.style.display = "block";

            spanAliasA.style.display = "block";
            spanAliasB.style.display = "block";
            spanAliasC.style.display = "block";

            spanScoreA.style.display = "block";
            spanScoreB.style.display = "block";
            spanScoreC.style.display = "block";
        }

        function showOption(response) {
            option = response[10].value;

            if (option == 14) {
                clearOptions();
                clearRanking();
                imgSelec14.style.display = "block";
            } else if (option == 24) {
                clearOptions();
                clearRanking();
                imgSelec24.style.display = "block";
            } else if (option == 34) {
                clearOptions();
                clearRanking();
                imgSelec34.style.display = "block";
            } else if (option == 44) {
                clearOptions();
                clearRanking();
                imgSelec44.style.display = "block";
            } else if (option == 13) {
                clearOptions();
                clearRanking();
                imgSelec13.style.display = "block";
            } else if (option == 23) {
                clearOptions();
                clearRanking();
                imgSelec23.style.display = "block";
            } else if (option == 33) {
                clearOptions();
                clearRanking();
                imgSelec33.style.display = "block";
            }
        }

        function clearOptions() {
            imgSelec14.style.display = "none";
            imgSelec24.style.display = "none";
            imgSelec34.style.display = "none";
            imgSelec44.style.display = "none";
            imgSelec13.style.display = "none";
            imgSelec23.style.display = "none";
            imgSelec33.style.display = "none";
        }

        function clearRanking() {
            imgPrimero.style.display = "none";
            imgSegundo.style.display = "none";
            imgTercero.style.display = "none";
            spanAliasA.style.display = "none";
            spanAliasB.style.display = "none";
            spanAliasC.style.display = "none";
            spanScoreA.style.display = "none";
            spanScoreB.style.display = "none";
            spanScoreC.style.display = "none";
        }
    </script>
</body>

</html>
