<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Videoplayer</title>
    <link rel="stylesheet" href="css/videoplayer.css">
</head>

<body>
    <span id="spanTempo"></span>
    <span id="spanContra"></span>

    <img id="imgSelec14" src="media/selecarriba.svg"></img>
    <img id="imgSelec24" src="media/selecarriba.svg"></img>
    <img id="imgSelec34" src="media/selecabajo.svg"></img>
    <img id="imgSelec44" src="media/selecabajo.svg"></img>

    <img id="imgSelec13" src="media/selec.svg"></img>
    <img id="imgSelec23" src="media/selec.svg"></img>
    <img id="imgSelec33" src="media/selec.svg"></img>

    <img id="imgPrimero" style="display: none;" src="media/primero.svg"></img>
    <img id="imgSegundo" style="display: none;" src="media/segundo.svg"></img>
    <img id="imgTercero" style="display: none;" src="media/tercero.svg"></img>

    <strong><span id="spanAliasA"></span></strong>
    <span id="spanScoreA"></span>
    <strong><span id="spanAliasB"></span></strong>
    <span id="spanScoreB"></span>
    <strong><span id="spanAliasC"></span></strong>
    <span id="spanScoreC"></span>

    <div class="fullscreen-bg">
        <video id="videoPlayer1" autoplay muted></video>
        <video id="videoPlayer2" autoplay muted></video>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script>
        var semaphore = 1;
        var play = true;
        var mode = "questions";
        var category = "mandatory";
        var mandatory = 1;
        var general = 1;
        var lead = 1;
        var option = 0;
        var solution = false;
        var time = 0;
        var ctime = 0;

        $(document).ready(function() {
            runPoll();
        });

        function runPoll() {
            setTimeout(function() {
                $.ajax({
                    url: 'http://olimpiadaserver.ddns.net:8888/server/bachServer.php',
                    success: function(response) {
                        checkPlay(response);
                        setTimer(response);
                        if (option != response[7].value) {
                            showOption(response);
                            if (option != 0) {
                                ctime = 5;
                                setCounterattack();
                            }
                        }
                        if (solution != response[8].value) {
                            showSolution(response);
                        }
                        if (response[0].value == "questions") {
                            if (mandatory != response[3].value[0] || general != response[4].value[0]) {
                                changeQuestion(response);
                            }
                        } else if (response[0].value == "leads") {
                            if (lead != response[1].value) {
                                changeLead(response);
                            }
                        } else if (response[0].value == "ranking") {
                            if (mode != response[0].value) {
                                changeRanking(response);
                            }
                        }
                    },
                    dataType: "json",
                    complete: function() {
                        runPoll();
                    }
                })
            }, 100);
        };

        function checkPlay(response) {
            play = response[5].value;

            if (videoPlayer1.style.display != "none") {
                if (!videoPlayer1.ended) {
                    if (play == true) {
                        if (videoPlayer1.paused) {
                            videoPlayer1.play();
                        }
                    } else if (play == false) {
                        if (!videoPlayer1.paused) {
                            videoPlayer1.pause();
                        }
                    }
                }
            } else if (videoPlayer2.style.display != "none") {
                if (!videoPlayer2.ended) {
                    if (play == true) {
                        if (videoPlayer2.paused) {
                            videoPlayer2.play();
                        }
                    } else if (play == false) {
                        if (!videoPlayer2.paused) {
                            videoPlayer2.pause();
                        }
                    }
                }
            }
        }

        function setTimer(response) {
            time = response[6].value;

            if (time >= 0) {
                spanTempo.innerHTML = time;
                spanTempo.style.display = "block";
            } else {
                spanTempo.innerHTML = "";
                spanTempo.style.display = "none";
            }
        }

        function setCounterattack() {
            if (ctime >= 0) {
                spanContra.innerHTML = "Contra " + ctime;
                spanContra.style.display = "block";
                ctime -= 1;
                setTimeout("setCounterattack()", 1000);
            } else {
                spanContra.innerHTML = "";
                spanContra.style.display = "none";
            }
        }

        function showSolution(response) {
            solution = response[8].value;

            if (solution == true) {
                if (semaphore % 2 == 0) {
                    if (category == "mandatory") {
                        videoPlayer1.src = "media/questions/bach/mandatory/" + mandatory + "/" + option + ".mp4";
                    } else if (category == "general") {
                        videoPlayer1.src = "media/questions/bach/general/" + general + "/" + option + ".mp4";
                    }
                    videoPlayer1.oncanplaythrough = function() {
                        clearOptions();
                        clearRanking();
                        videoPlayer2.style.display = "none";
                        videoPlayer1.style.display = "block";
                        semaphore++;
                    }
                } else {
                    if (category == "mandatory") {
                        videoPlayer2.src = "media/questions/bach/mandatory/" + mandatory + "/" + option + ".mp4";
                    } else if (category == "general") {
                        videoPlayer2.src = "media/questions/bach/general/" + general + "/" + option + ".mp4";
                    }
                    videoPlayer2.oncanplaythrough = function() {
                        clearOptions();
                        clearRanking();
                        videoPlayer1.style.display = "none";
                        videoPlayer2.style.display = "block";
                        semaphore++;
                    }
                }
            }
        }

        function changeQuestion(response) {
            mode = response[0].value;
            category = response[2].value;
            mandatory = response[3].value[0];
            general = response[4].value[0];

            if (semaphore % 2 == 0) {
                if (category == "mandatory") {
                    videoPlayer1.src = "media/questions/bach/mandatory/" + mandatory + "/0.mp4";
                } else if (category == "general") {
                    videoPlayer1.src = "media/questions/bach/general/" + general + "/0.mp4";
                }
                videoPlayer1.oncanplaythrough = function() {
                    clearOptions();
                    clearRanking();
                    videoPlayer2.style.display = "none";
                    videoPlayer1.style.display = "block";
                    semaphore++;
                }
            } else {
                if (category == "mandatory") {
                    videoPlayer2.src = "media/questions/bach/mandatory/" + mandatory + "/0.mp4";
                } else if (category == "general") {
                    videoPlayer2.src = "media/questions/bach/general/" + general + "/0.mp4";
                }
                videoPlayer2.oncanplaythrough = function() {
                    clearOptions();
                    clearRanking();
                    videoPlayer1.style.display = "none";
                    videoPlayer2.style.display = "block";
                    semaphore++;
                }
            }
        }

        function changeLead(response) {
            lead = response[1].value;
            mode = response[0].value;

            if (semaphore % 2 == 0) {
                videoPlayer1.src = "media/leads/" + lead + ".mp4";
                videoPlayer1.oncanplaythrough = function() {
                    clearOptions();
                    clearRanking();
                    videoPlayer2.style.display = "none";
                    videoPlayer1.style.display = "block";
                    semaphore++;
                }
            } else {
                videoPlayer2.src = "media/leads/" + lead + ".mp4";
                videoPlayer2.oncanplaythrough = function() {
                    clearOptions();
                    clearRanking();
                    videoPlayer1.style.display = "none";
                    videoPlayer2.style.display = "block";
                    semaphore++;
                }
            }
        }

        function changeRanking(response) {
            mode = response[0].value;

            if (semaphore % 2 == 0) {
                videoPlayer1.src = "media/ranking/1.mp4";
                videoPlayer1.oncanplaythrough = function() {
                    clearOptions();
                    clearRanking();
                    setRanking(response);
                    videoPlayer2.style.display = "none";
                    videoPlayer1.style.display = "block";
                    semaphore++;
                }
            } else {
                videoPlayer2.src = "media/ranking/1.mp4";
                videoPlayer2.oncanplaythrough = function() {
                    clearOptions();
                    clearRanking();
                    setRanking(response);
                    videoPlayer1.style.display = "none";
                    videoPlayer2.style.display = "block";
                    semaphore++;
                }
            }
        }

        function setRanking(response) {
            teamA = response[11];
            teamB = response[12];
            teamC = response[13];

            var arr = [];
            arr.push(teamA, teamB, teamC);
            arr.sort(function(obj1, obj2) {
                return obj1.value[1] - obj2.value[1];
            });

            $("#imgPrimero").addClass(arr[2]._id);
            $("#imgSegundo").addClass(arr[1]._id);
            $("#imgTercero").addClass(arr[0]._id);

            imgPrimero.style.display = "block";
            imgSegundo.style.display = "block";
            imgTercero.style.display = "block";

            spanAliasA.innerHTML = response[11].value[0];
            spanAliasB.innerHTML = response[12].value[0];
            spanAliasC.innerHTML = response[13].value[0];

            spanAliasA.style.display = "block";
            spanAliasB.style.display = "block";
            spanAliasC.style.display = "block";

            spanScoreA.innerHTML = response[11].value[1];
            spanScoreB.innerHTML = response[12].value[1];
            spanScoreC.innerHTML = response[13].value[1];

            spanScoreA.style.display = "block";
            spanScoreB.style.display = "block";
            spanScoreC.style.display = "block";
        }

        function showOption(response) {
            option = response[7].value;

            if (option == 14) {
                clearOptions();
                clearRanking();
                imgSelec14.style.display = "block";
            } else if (option == 24) {
                clearOptions();
                clearRanking();
                imgSelec24.style.display = "block";
            } else if (option == 34) {
                clearOptions();
                clearRanking();
                imgSelec34.style.display = "block";
            } else if (option == 44) {
                clearOptions();
                clearRanking();
                imgSelec44.style.display = "block";
            } else if (option == 13) {
                clearOptions();
                clearRanking();
                imgSelec13.style.display = "block";
            } else if (option == 23) {
                clearOptions();
                clearRanking();
                imgSelec23.style.display = "block";
            } else if (option == 33) {
                clearOptions();
                clearRanking();
                imgSelec33.style.display = "block";
            }
        }

        function clearOptions() {
            imgSelec14.style.display = "none";
            imgSelec24.style.display = "none";
            imgSelec34.style.display = "none";
            imgSelec44.style.display = "none";
            imgSelec13.style.display = "none";
            imgSelec23.style.display = "none";
            imgSelec33.style.display = "none";
        }

        function clearRanking() {
            imgPrimero.style.display = "none";
            imgSegundo.style.display = "none";
            imgTercero.style.display = "none";
            spanAliasA.style.display = "none";
            spanAliasB.style.display = "none";
            spanAliasC.style.display = "none";
            spanScoreA.style.display = "none";
            spanScoreB.style.display = "none";
            spanScoreC.style.display = "none";
        }
    </script>
</body>

</html>
