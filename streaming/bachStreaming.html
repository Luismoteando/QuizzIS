<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Streaming</title>
  <link rel="stylesheet" href="css/streaming.css">
</head>
<body>
  <span id="timer"></span>
  <img id="selec14" src="media/selecarriba.svg"></img>
  <img id="selec24" src="media/selecarriba.svg"></img>
  <img id="selec34" src="media/selecabajo.svg"></img>
  <img id="selec44" src="media/selecabajo.svg"></img>
  <img id="selec13" src="media/selecabajo.svg"></img>
  <img id="selec23" src="media/selecabajo.svg"></img>
  <img id="selec33" src="media/selecabajo.svg"></img>
  <div class="fullscreen-bg">
    <video id="player1" src="media/video1/opcion0.mp4" autoplay muted></video>
    <video id="player2" src="media/video1/opcion0.mp4" autoplay muted></video>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <script>
  var timer = document.getElementById("timer");
  var selec14 = document.getElementById("selec14");
  var selec24 = document.getElementById("selec24");
  var selec34 = document.getElementById("selec34");
  var selec44 = document.getElementById("selec44");
  var selec13 = document.getElementById("selec13");
  var selec23 = document.getElementById("selec23");
  var selec33 = document.getElementById("selec33");
  var player1 = document.getElementById("player1");
  var player2 = document.getElementById("player2");

  var semaphore = 1;
  var play = "true";
  var video = 1;
  var option = 0;
  var time = 0;

  $(document).ready(function () {
    runPoll();
  });

  function runPoll() {
    setTimeout(function () {
      $.ajax({
        url: 'http://olistreaming.ddns.net:8888/server/bachServer.php',
        success: function (response) {
          checkPlay(response);
          setTimer(response);
          if(option != response[2].value) {
            changeOption(response);
          }
          if(video != response[1].value) {
            changeVideo(response);
          }
        },
        dataType: "json",
        complete: function () {
          runPoll();
        }
      })
    }, 100);
  };

  function checkPlay(response) {
    play = response[0].value;

    if(player1.style.display != "none") {
      if(play == "true") {
        if(player1.paused) {
          player1.play();
        }
      } else if(play == "false"){
        if(!player1.paused) {
          player1.pause();
        }
      }
    } else if(player2.style.display != "none") {
      if(play == "true") {
        if(player2.paused) {
          player2.play();
        }
      } else if(play == "false"){
        if(!player2.paused) {
          player2.pause();
        }
      }
    }
  }

  function setTimer(response) {
    time = response[6].value;

    if(time > 0) {
      timer.innerHTML = time;
      timer.style.display = "block";
    } else {
      timer.innerHTML = time;
      setTimeout(function() {
      timer.style.display = "none";
      }, 1000);
    }
  }

  function changeVideo(response) {
    video = response[1].value;

    clearOptions();
    if(semaphore % 2 == 0) {
      player1.src = "media/video" + response[1].value + "/opcion0.mp4";
      setTimeout(function() {
        player2.style.display = "none";
        player1.style.display = "block";
        semaphore++;
      }, 500);
    } else {
      player2.src = "media/video" + response[1].value + "/opcion0.mp4";
      setTimeout(function() {
        player1.style.display = "none";
        player2.style.display = "block";
        semaphore++;
      }, 500);
    }
  }

  function changeOption(response) {
    video = response[1].value;
    option = response[2].value;

    if(option == 14) {
      clearOptions();
      selec14.style.display = "block";
    } else if(option == 24) {
      clearOptions();
      selec24.style.display = "block";
    } else if(option == 34) {
      clearOptions();
      selec34.style.display = "block";
    } else if(option == 44) {
      clearOptions();
      selec44.style.display = "block";
    } else if(option == 13) {
      clearOptions();
      selec13.style.display = "block";
    } else if(option == 23) {
      clearOptions();
      selec23.style.display = "block";
    } else if(option == 33) {
      clearOptions();
      selec33.style.display = "block";
    }

    setTimeout(function() {
      clearOptions();
      if(semaphore % 2 == 0) {
        player1.src = "media/video" + response[1].value + "/opcion" + option + ".mp4";
        setTimeout(function() {
          player2.style.display = "none";
          player1.style.display = "block";
          semaphore++;
        }, 500);
      } else {
        player2.src = "media/video" + response[1].value + "/opcion" + option + ".mp4";
        setTimeout(function() {
          player1.style.display = "none";
          player2.style.display = "block";
          semaphore++;
        }, 500);
      }
    }, 3000);
  }

  function clearOptions() {
    selec14.style.display = "none";
    selec24.style.display = "none";
    selec34.style.display = "none";
    selec44.style.display = "none";
    selec13.style.display = "none";
    selec23.style.display = "none";
    selec33.style.display = "none";
  }
  </script>
</body>
</html>
