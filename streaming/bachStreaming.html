<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Streaming</title>
  <link rel="stylesheet" href="css/streaming.css">
</head>
<body>
  <img id="selec1" src="media/selecarriba.svg"></img>
  <img id="selec2" src="media/selecarriba.svg"></img>
  <img id="selec3" src="media/selecabajo.svg"></img>
  <img id="selec4" src="media/selecabajo.svg"></img>
  <div class="fullscreen-bg">
    <video id="player1" src="media/video1/opcion0.mp4" autoplay muted></video>
    <video id="player2" src="media/video1/opcion0.mp4" autoplay muted></video>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <script>
  var selec1 = document.getElementById("selec1");
  var selec2 = document.getElementById("selec2");
  var selec3 = document.getElementById("selec3");
  var selec4 = document.getElementById("selec4");
  var player1 = document.getElementById("player1");
  var player2 = document.getElementById("player2");

  var semaphore = 1;
  var play = "true";
  var video = 1;
  var option = 0;

  $(document).ready(function () {
    runPoll();
  });

  function runPoll() {
    setTimeout(function () {
      $.ajax({
        url: 'http://olistreaming.ddns.net:8888/server/bachServer.php',
        success: function (response) {
          checkPlay(response);
          if(option != response[2].value) {
            changeOption(response);
          }
          if(video != response[1].value) {
            changeVideo(response);
          }
        },
        dataType: "json",
        complete: function () {
          runPoll();
        }
      })
    }, 100);
  };

  function checkPlay(response) {
    play = response[0].value;

    if(player1.style.display != "none") {
      if(play == "true") {
        if(player1.paused) {
          player1.play();
        }
      } else if(play == "false"){
        if(!player1.paused) {
          player1.pause();
        }
      }
    } else if(player2.style.display != "none") {
      if(play == "true") {
        if(player2.paused) {
          player2.play();
        }
      } else if(play == "false"){
        if(!player2.paused) {
          player2.pause();
        }
      }
    }
  }

  function changeVideo(response) {
    video = response[1].value;

    clearOptions();
    if(semaphore % 2 == 0) {
      player1.src = "media/video" + response[1].value + "/opcion0.mp4";
      setTimeout(function() {
        player2.style.display = "none";
        player1.style.display = "block";
        semaphore++;
      }, 500);
    } else {
      player2.src = "media/video" + response[1].value + "/opcion0.mp4";
      setTimeout(function() {
        player1.style.display = "none";
        player2.style.display = "block";
        semaphore++;
      }, 500);
    }
  }

  function changeOption(response) {
    video = response[1].value;
    option = response[2].value;

    if(option == 1) {
      selec1.style.display = "block";
      selec2.style.display = "none";
      selec3.style.display = "none";
      selec4.style.display = "none";
    } else if(option == 2) {
      selec1.style.display = "none";
      selec2.style.display = "block";
      selec3.style.display = "none";
      selec4.style.display = "none";
    } else if(option == 3) {
      selec1.style.display = "none";
      selec2.style.display = "none";
      selec3.style.display = "block";
      selec4.style.display = "none";
    } else if(option == 4) {
      selec1.style.display = "none";
      selec2.style.display = "none";
      selec3.style.display = "none";
      selec4.style.display = "block";
    }

    setTimeout(function() {
      clearOptions();
      if(semaphore % 2 == 0) {
        player1.src = "media/video" + response[1].value + "/opcion" + option + ".mp4";
        setTimeout(function() {
          player2.style.display = "none";
          player1.style.display = "block";
          semaphore++;
        }, 500);
      } else {
        player2.src = "media/video" + response[1].value + "/opcion" + option + ".mp4";
        setTimeout(function() {
          player1.style.display = "none";
          player2.style.display = "block";
          semaphore++;
        }, 500);
      }
    }, 3000);
  }

  function clearOptions() {
    selec1.style.display = "none";
    selec2.style.display = "none";
    selec3.style.display = "none";
    selec4.style.display = "none";
  }
  </script>
</body>
</html>
