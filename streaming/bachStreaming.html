<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Streaming</title>
  <link rel="stylesheet" href="css/streaming.css">
</head>
<body>
  <span id="timer"></span>
  <span id="counterattack"></span>
  <img id="selec14" src="media/selecarriba.svg"></img>
  <img id="selec24" src="media/selecarriba.svg"></img>
  <img id="selec34" src="media/selecabajo.svg"></img>
  <img id="selec44" src="media/selecabajo.svg"></img>
  <img id="selec13" src="media/selec.svg"></img>
  <img id="selec23" src="media/selec.svg"></img>
  <img id="selec33" src="media/selec.svg"></img>
  <div class="fullscreen-bg">
    <video id="player1" autoplay muted></video>
    <video id="player2" autoplay muted></video>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <script>
  var semaphore = 1;
  var play = "true";
  var video = 1;
  var option = 0;
  var solution = "false";
  var time = 0;
  var ctime = 0;

  $(document).ready(function () {
    runPoll();
  });

  function runPoll() {
    setTimeout(function () {
      $.ajax({
        url: 'http://olistreaming.ddns.net:8888/server/bachServer.php',
        success: function (response) {
          checkPlay(response);
          setTimer(response);
          if(option != response[2].value) {
            showOption(response);
            if(option != 0) {
              ctime = 5;
              setCounterattack();
            }
          }
          if(solution != response[10].value) {
            showSolution(response);
          }
          if(video != response[1].value) {
            changeVideo(response);
          }
        },
        dataType: "json",
        complete: function () {
          runPoll();
        }
      })
    }, 100);
  };

  function checkPlay(response) {
    play = response[0].value;

    if(player1.style.display != "none") {
      if(!player1.ended) {
        if(play == "true") {
          if(player1.paused) {
            player1.play();
          }
        } else if(play == "false") {
          if(!player1.paused) {
            player1.pause();
          }
        }
      }
    } else if(player2.style.display != "none") {
      if(!player2.ended) {
        if(play == "true") {
          if(player2.paused) {
            player2.play();
          }
        } else if(play == "false"){
          if(!player2.paused) {
            player2.pause();
          }
        }
      }
    }
  }

  function setTimer(response) {
    time = response[6].value;

    if(time >= 0) {
      timer.innerHTML = time;
      timer.style.display = "block";
    } else {
      timer.innerHTML = "";
      timer.style.display = "none";
    }
  }

  function setCounterattack() {
      if(ctime >= 0) {
        counterattack.innerHTML = "Contra " + ctime;
        counterattack.style.display = "block";
        ctime -= 1;
        setTimeout("setCounterattack()", 1000);
      } else {
        counterattack.innerHTML = "";
        counterattack.style.display = "none";
      }
  }

  function showSolution(response) {
    solution = response[10].value;

    if(solution == "true") {
      if(semaphore % 2 == 0) {
        player1.src = "media/video" + video + "/opcion" + option + ".mp4";
        player1.oncanplaythrough = function() {
          clearOptions();
          player2.style.display = "none";
          player1.style.display = "block";
          semaphore++;
        }
      } else {
        player2.src = "media/video" + video + "/opcion" + option + ".mp4";
        player2.oncanplaythrough = function() {
          clearOptions();
          player1.style.display = "none";
          player2.style.display = "block";
          semaphore++;
        }
      }
    }
  }

  function changeVideo(response) {
    video = response[1].value;

    clearOptions();
    if(semaphore % 2 == 0) {
      player1.src = "media/video" + video + "/opcion0.mp4";
      player1.oncanplaythrough = function() {
        player2.style.display = "none";
        player1.style.display = "block";
        semaphore++;
      }
    } else {
      player2.src = "media/video" + video + "/opcion0.mp4";
      player2.oncanplaythrough = function() {
        player1.style.display = "none";
        player2.style.display = "block";
        semaphore++;
      }
    }
  }

  function showOption(response) {
    option = response[2].value;

    if(option == 14) {
      clearOptions();
      selec14.style.display = "block";
    } else if(option == 24) {
      clearOptions();
      selec24.style.display = "block";
    } else if(option == 34) {
      clearOptions();
      selec34.style.display = "block";
    } else if(option == 44) {
      clearOptions();
      selec44.style.display = "block";
    } else if(option == 13) {
      clearOptions();
      selec13.style.display = "block";
    } else if(option == 23) {
      clearOptions();
      selec23.style.display = "block";
    } else if(option == 33) {
      clearOptions();
      selec33.style.display = "block";
    }
  }

  function clearOptions() {
    selec14.style.display = "none";
    selec24.style.display = "none";
    selec34.style.display = "none";
    selec44.style.display = "none";
    selec13.style.display = "none";
    selec23.style.display = "none";
    selec33.style.display = "none";
  }
  </script>
</body>
</html>
